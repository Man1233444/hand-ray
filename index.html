<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Sniper Scope Stable Zoom</title>
<style>
html, body { margin:0; padding:0; width:100%; height:100%; background:black; overflow:hidden; }
#video { position:absolute; width:100%; height:100%; object-fit:cover; transform-origin:center center; transition: transform 0.2s linear; }
#start { position:fixed; inset:0; background:black; color:white; font-size:32px; display:flex; align-items:center; justify-content:center; z-index:10; cursor:pointer; }
.sniper-overlay { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:5; }
.scope-circle { position:absolute; width:70vmin; height:70vmin; border:4px solid white; border-radius:50%; top:50%; left:50%; transform:translate(-50%,-50%); }
.crosshair { position:absolute; width:60px; height:60px; top:50%; left:50%; transform:translate(-50%,-50%); }
.crosshair::before, .crosshair::after { content:""; position:absolute; background:red; }
.crosshair::before { width:100%; height:3px; top:50%; left:0; transform:translateY(-50%); }
.crosshair::after { width:3px; height:100%; top:0; left:50%; transform:translateX(-50%); }
</style>
</head>
<body>

<video id="video" autoplay playsinline muted></video>
<div id="start">TAP TO START</div>

<div class="sniper-overlay">
  <div class="scope-circle"></div>
  <div class="crosshair"></div>
</div>

<script>
const video = document.getElementById("video");
const startBtn = document.getElementById("start");

let steadyTime = 0;
const maxZoom = 2;
const zoomDuration = 17; // seconds to full zoom
let zoomLevel = 1;

const canvas = document.createElement("canvas");
const ctx = canvas.getContext("2d");

// Movement smoothing
let pixelHistory = [];
const historyLength = 10; // more frames for stability
const movementThreshold = 100; // higher = ignore small shakes
const smoothFactor = 0.05; // easing zoom

startBtn.addEventListener("click", async () => {
  startBtn.style.display = "none";
  document.documentElement.requestFullscreen?.().catch(()=>{});

  const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}, audio:false});
  video.srcObject = stream;

  requestAnimationFrame(autoZoom);
});

function autoZoom(){
  const w = video.videoWidth;
  const h = video.videoHeight;

  if(w > 0 && h > 0){
    canvas.width = w;
    canvas.height = h;
    ctx.drawImage(video,0,0,w,h);
    const data = ctx.getImageData(w/2,h/2,1,1).data;
    const pixel = [data[0],data[1],data[2]];

    // Save last few pixels
    pixelHistory.push(pixel);
    if(pixelHistory.length > historyLength) pixelHistory.shift();

    // Compute average delta over history
    let movementDetected = false;
    if(pixelHistory.length >= 2){
      let totalDelta = 0;
      for(let i=1;i<pixelHistory.length;i++){
        const prev = pixelHistory[i-1];
        const curr = pixelHistory[i];
        totalDelta += Math.hypot(curr[0]-prev[0], curr[1]-prev[1], curr[2]-prev[2]);
      }
      const avgDelta = totalDelta / (pixelHistory.length-1);
      if(avgDelta > movementThreshold) movementDetected = true;
    }

    if(movementDetected){
      steadyTime = 0; // reset zoom timer
      zoomLevel += (1 - zoomLevel) * smoothFactor; // ease back
    } else {
      steadyTime += 1/60;
      const targetZoom = 1 + Math.min(steadyTime/zoomDuration,1)*(maxZoom-1);
      zoomLevel += (targetZoom - zoomLevel) * smoothFactor;
    }

    video.style.transform = `scale(${zoomLevel})`;
  }

  requestAnimationFrame(autoZoom);
}
</script>

</body>
</html>
